name: Reddit Automation Test

on:
  # Run on push to main branch
  push:
    branches: [ main, master ]
  
  # Run on pull requests
  pull_request:
    branches: [ main, master ]
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on schedule (daily at 9 AM UTC)
  schedule:
    - cron: '0 9 * * *'

jobs:
  reddit-automation-test:
    runs-on: ubuntu-22.04  # Use Ubuntu 22.04 for better Playwright compatibility
    
    strategy:
      matrix:
        python-version: ["3.10"]
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libasound2
    
    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ­ Install Playwright browsers and dependencies
      run: |
        # Install Firefox browser
        python -m playwright install firefox
        
        # Install system dependencies for Firefox
        sudo python -m playwright install-deps firefox || true
        
        # Verify Firefox installation
        python -c "from playwright.sync_api import sync_playwright; p = sync_playwright(); print('âœ… Firefox installed successfully')"
    
    - name: ğŸŒ Create environment file
      env:
        REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
        REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
      run: |
        echo "REDDIT_USERNAME=$REDDIT_USERNAME" > .env
        echo "REDDIT_PASSWORD=$REDDIT_PASSWORD" >> .env
        echo "TEST_HEADLESS=true" >> .env
        echo "TEST_SLOW_MO=1000" >> .env
        echo "CI=true" >> .env
    
    - name: ğŸ” Debug environment
      run: |
        echo "ğŸ” Environment Debug Info:"
        echo "Python version: $(python --version)"
        echo "Pip version: $(pip --version)"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Environment file contents:"
        cat .env || echo "No .env file found"
        echo "Firefox installation check:"
        python -m playwright install firefox --dry-run || echo "Firefox check completed"
    
    - name: ğŸ§ª Run Reddit Automation Test
      env:
        CI: true
        HEADLESS: true
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ğŸš€ Starting Reddit Automation Test in CI mode..."
        
        # Run with simple pytest command for CI
        python -m pytest step_definitions/reddit_steps.py::test_reddit_automation \
          -v \
          --tb=short \
          --disable-warnings \
          --no-header \
          || exit 1
    
    
    - name: âœ… Test completion notification
      if: success()
      run: |
        echo "âœ… Reddit Automation Test completed successfully!"
        echo "ğŸ¯ Validated Features:"
        echo "   â€¢ BDD test structure with Gherkin scenarios"
        echo "   â€¢ Reddit authentication and session management"
        echo "   â€¢ Gaming subreddit navigation and interaction"
        echo "   â€¢ Smart post detection (excludes pinned/promoted)"
        echo "   â€¢ Nintendo content analysis with voting logic"
        echo "   â€¢ Automated logout with verification"
        echo "   â€¢ CI/CD integration with headless browser"
        echo ""
        echo "ğŸš€ Test demonstrates enterprise-level automation capabilities!"
    
    - name: âŒ Test failure notification  
      if: failure()
      run: |
        echo "âŒ Reddit Automation Test failed!"
        echo "ğŸ“‹ Common causes:"
        echo "   â€¢ Reddit credentials not configured in GitHub Secrets"
        echo "   â€¢ Reddit rate limiting or temporary blocks"
        echo "   â€¢ Browser/dependency installation issues"
        echo "   â€¢ Network connectivity problems"
        echo ""
        echo "ğŸ” Check the uploaded artifacts for detailed logs"
        echo "ğŸ’¡ Tip: Test locally first with 'python ci_test_runner.py'"